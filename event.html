<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>이벤트 페이지</title>
<style>
  body {
    font-family: "Malgun Gothic", sans-serif;
    background-color: #f2f5f8;
    margin: 0;
    padding: 0;
    font-size: 14px;
  }
  .chat-container {
    width: 100%;
    max-width: 500px;
    box-sizing: border-box;
    height: 600px;
    overflow-y: auto;
    margin: 40px auto 10px;
    padding: 10px;
    background-color: #e0f3ff;
    border-radius: 15px;
    padding-bottom: 20px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
  }
  .chat-card {
    max-width: 100%;
    padding: 16px;
    margin: 20px auto;
    border-radius: 12px;
    background-color: #ffffff;
    border: 1px solid #ccc;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    font-size: 14px;
    line-height: 1.6;
    word-wrap: break-word;
    box-sizing: border-box;
    text-align: left;
    position: relative;
  }
  .card-footer {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    margin-top: 10px;
    gap: 12px;
  }
  .timestamp {
    font-size: 12px;
    color: #888;
  }
  .input-container {
    max-width: 500px;
    margin: 10px auto;
    display: flex;
    gap: 8px;
    padding: 0 10px;
  }
  #chatInput {
    flex: 1;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 14px;
  }
  #sendBtn {
    padding: 10px 16px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }
  #sendBtn:hover {
    background-color: #0056b3;
  }
  #adminBtn {
    display: block;
    margin: 0 auto 20px;
    background-color: #333;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 8px 14px;
    cursor: pointer;
    font-size: 14px;
  }
  .delete-button {
    background-color: #999;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 4px 10px;
    font-size: 13px;
    cursor: pointer;
    position: absolute;
    top: 10px;
    right: 10px;
  }
  .like-button {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 18px;
  }
  .like-button.liked {
    color: #007bff;
  }
  .like-count {
    font-size: 14px;
    color: #333;
    margin-left: 4px;
  }
</style>
</head>
<body>


<div style="max-width: 500px; margin: 20px auto 0; padding: 0 10px; font-size: 17px; font-weight: bold; color: #000000; text-align: center;">
1. 다음 여성시대 <span style="color: red;">저격/부정적 언급 금지</span></br></br>
2. 전생달글 언급 금지</br></br>
3. 나눔받은 물품 상세 언급 금지</br>
<small style="color: #888888;">ex. 나눔받은 음식 먹으며 버틸 수 있었다. ⭕</br>
나눔받은 김밥 먹으며 버틸 수 있었다. ❌</small>
</br></br>
🧨공지 어긴 글은 무통보 삭제합니다.🧨
</div>
<div class="chat-container" id="chatBox"></div>

<div class="input-container">
  <input type="text" id="chatInput" placeholder="등록 후 수정/삭제 불가. 공지 어긴 글은 달주가 무통보 삭제."/>
  <button id="sendBtn">등록</button>
</div>

<button id="adminBtn">🔒 달주 전용</button>







<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  addDoc,
  deleteDoc,
  doc,
  getDoc,
  updateDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAZHqkGXdH4XxL-0jprA2DB7YO4XhTdNmQ",
  authDomain: "chat-page-6d547.firebaseapp.com",
  projectId: "chat-page-6d547",
  storageBucket: "chat-page-6d547.appspot.com",
  messagingSenderId: "1087235341754",
  appId: "1:1087235341754:web:6583340a62f21068b5b183"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
let isAdmin = false;

document.getElementById("sendBtn").onclick = async () => {
  const input = document.getElementById("chatInput");
  const text = input.value.trim();
  if (!text) return;

  // 닉네임 자동 부여
  const counterRef = doc(db, "meta", "nicknameCounter");
  const counterSnap = await getDoc(counterRef);
  let nickname = "익명 ?";
  if (counterSnap.exists()) {
    const count = counterSnap.data().count || 1;
    nickname = `익명 ${count}`;
    await updateDoc(counterRef, { count: count + 1 });  // 다음 번호로 증가
  }

  await addDoc(collection(db, "chat"), {
    text,
    timestamp: serverTimestamp(),
    likes: 0,
    nickname
  });
  input.value = "";
  loadChat();
};

async function loadChat() {
  const box = document.getElementById("chatBox");
  box.innerHTML = "";
  const snapshot = await getDocs(collection(db, "chat"));
  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    const id = docSnap.id;
    const key = `liked_${id}`;
    const liked = localStorage.getItem(key) === "true";

    const div = document.createElement("div");
    div.className = "chat-card";



div.innerHTML = `
  ${isAdmin ? `<button class="delete-button" onclick="deleteChat('${id}')">삭제</button>` : ""}
  <div><strong>${data.nickname || "익명"}</strong></div>
  <div>${data.text}</div>
  <div class="card-footer">
        <button class="like-button ${liked ? "liked" : ""}" onclick="likeChat('${id}', this)">${liked ? "💙" : "♡"}</button>
        <span class="like-count">${data.likes || 0}</span>
        <div class="timestamp">${data.timestamp && data.timestamp.toDate ? (() => {
  const date = new Date(data.timestamp.toDate());
  return date.toLocaleString("ko-KR", {
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit"
  });
})() : ""}</div>
      </div>
    `;
    box.appendChild(div);
  });
  box.scrollTop = box.scrollHeight;
}

window.deleteChat = async function(id) {
  const ok = confirm("삭제할까요?");
  if (!ok) return;
  await deleteDoc(doc(db, "chat", id));
  loadChat();
};

window.likeChat = async function(id, btn) {
  const key = `liked_${id}`;
  const ref = doc(db, "chat", id);
  const snap = await getDoc(ref);
  if (!snap.exists()) return;
  const data = snap.data();
  const countSpan = btn.nextElementSibling;
  let currentLikes = data.likes || 0;

  const liked = localStorage.getItem(key) === "true";
  if (liked) {
    await updateDoc(ref, { likes: currentLikes - 1 });
    localStorage.setItem(key, "false");
    btn.classList.remove("liked");
    btn.innerHTML = "♡";
    countSpan.textContent = currentLikes - 1;
  } else {
    await updateDoc(ref, { likes: currentLikes + 1 });
    localStorage.setItem(key, "true");
    btn.classList.add("liked");
    btn.innerHTML = "💙";
    countSpan.textContent = currentLikes + 1;
  }
};

document.getElementById("adminBtn").onclick = async () => {
  const pwd = prompt("비밀번호를 입력하세요");
  if (!pwd) return;
  const snap = await getDoc(doc(db, "admin", "secret"));
  if (!snap.exists()) return alert("비밀번호 데이터 없음");
  const real = snap.data().password;
  if (pwd === real) {
    isAdmin = true;
    loadChat();
    alert("관리자 권한이 활성화되었습니다.");
  } else {
    alert("비밀번호가 틀렸습니다.");
  }
};

loadChat();
</script>





</body>
</html>
