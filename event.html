
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>오늘의 메시지</title>
<style>
  body {
    font-family: "Malgun Gothic", sans-serif;
    background-color: #f2f5f8;
    margin: 0;
    padding: 0;
    font-size: 14px;
  }
.chat-text.preview {
  max-height: 7.3em;
  overflow: hidden;
}
.chat-text.expanded {
  max-height: none;
}
.toggle-more {
  text-align: right;
  font-size: 12px;
  color: gray;
  cursor: pointer;
  margin-top: 6px;
}
  .chat-container {
    width: 100%;
    max-width: 500px;
    box-sizing: border-box;
    height: 90vh;
    overflow-y: auto;
    margin: 40px auto 10px;
    padding: 10px;
    background-color: #e0f3ff;
    border-radius: 15px;
    padding-bottom: 20px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
  }
#editInput {
  width: 100%;
  display: none;
  padding: 10px;
  font-size: 14px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-family: 'Malgun Gothic', sans-serif;
  box-sizing: border-box;
  resize: none;
  overflow: hidden;
  min-height: 38px;
}

  .chat-card {
    max-width: 100%;
    padding: 16px;
    margin: 20px auto;
    border-radius: 12px;
    border: 1px solid #ccc;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    font-size: 14px;
    line-height: 1.6;
    word-wrap: break-word;
    box-sizing: border-box;
    text-align: left;
    position: relative;
  }
.card-footer {
  display: flex;
  justify-content: space-between; /* 양쪽 정렬로 바꿈 */
  align-items: center;
  margin-top: 10px;
}

  .timestamp {
    font-size: 12px;
    color: #888;
  }
  .input-container {
    max-width: 500px;
    margin: 10px auto;
    display: flex;
    gap: 8px;
    padding: 0 10px;
  }
#chatInput {
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 14px;
  font-family: 'Malgun Gothic', sans-serif;
  resize: none;
  overflow: hidden;
  box-sizing: border-box;
  min-height: 38px;
  /* flex: 1; ← 이 줄 제거! */
}


  #sendBtn {
    padding: 10px 16px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }
  #sendBtn:hover {
    background-color: #0056b3;
  }
  #adminBtn {
    display: block;
    margin: 0 auto 20px;
    background-color: #333;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 8px 14px;
    cursor: pointer;
    font-size: 14px;
  }
.admin-button {
  background-color: #999;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 4px 10px;
  font-size: 13px;
  cursor: pointer;
  margin-left: 6px;
}

  .like-button {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 18px;
  }
  .like-button.liked {
    color: #007bff;
  }
  .like-count {
    font-size: 14px;
    color: #333;
    margin-left: 4px;
  }

.pinned-card {
  position: sticky;
  top: 0;
  z-index: 9999; /* 가장 위로 올리기 */
  background-color: #fff8dc;
  border: 2px solid #ff8c00;
}

</style>
</head>
<body>

<div style="max-width: 500px; margin: 20px auto 0; padding: 0 10px; font-size: 17px; font-weight: bold; color: #000000; text-align: center;">

<div style="text-align:center; font-size:20px; margin-bottom:10px;">
  <strong class="sparkling-text">외부 공유 환영</strong>
</div>
<div class="chat-container" id="chatBox"></div>


<div class="input-container" style="flex-direction: column; gap: 10px;">
  <!-- 등록용 -->
  <textarea id="chatInput"
    rows="1"
    placeholder="등록 후 수정/삭제 불가. 공지 어긴 글은 달주가 무통보 삭제."
    style="width: 100%; padding: 10px; font-size: 14px; border-radius: 8px; border: 1px solid #ccc; font-family: 'Malgun Gothic', sans-serif; box-sizing: border-box; resize: none; overflow: hidden;"></textarea>
  <button id="sendBtn" style="align-self: flex-end;">등록</button>

  <!-- ✏️ 수정용 입력창도 같이 넣기 -->
  <textarea id="editInput"
    placeholder="수정할 내용을 입력하세요"
    rows="4"
    style="width: 100%; display: none; padding: 10px; font-size: 14px; border-radius: 8px; border: 1px solid #ccc; font-family: 'Malgun Gothic', sans-serif; box-sizing: border-box; resize: none; overflow: hidden;"></textarea>
  <button id="editSubmitBtn"
    style="display: none; align-self: flex-end; padding: 10px 16px; background-color: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer;">수정 완료</button>
</div>





<button id="adminBtn">🔒 달주 전용</button>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  addDoc,
  deleteDoc,
  doc,
  getDoc,
  updateDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAZHqkGXdH4XxL-0jprA2DB7YO4XhTdNmQ",
  authDomain: "chat-page-6d547.firebaseapp.com",
  projectId: "chat-page-6d547",
  storageBucket: "chat-page-6d547.appspot.com",
  messagingSenderId: "1087235341754",
  appId: "1:1087235341754:web:6583340a62f21068b5b183"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
let isAdmin = false;
let editingId = null;

const pastelColors = ['#fff5f7', '#fffdea', '#f0fbff', '#f0fff4', '#f7f3ff', '#fffaf0', '#fef4fb'];

document.getElementById("sendBtn").onclick = async () => {
  const input = document.getElementById("chatInput");
  const text = input.value.trim();
  if (!text) return;

  const counterRef = doc(db, "meta", "nicknameCounter");
  const counterSnap = await getDoc(counterRef);
  let nickname = "익명 ?";
  if (counterSnap.exists()) {
    const count = counterSnap.data().count || 1;
    nickname = `익명 ${count}`;
    await updateDoc(counterRef, { count: count + 1 });
  }

  await addDoc(collection(db, "chat"), {
    text,
    timestamp: serverTimestamp(),
    likes: 0,
    nickname
  });
  input.value = "";
  loadChat();
};

document.getElementById("editSubmitBtn").onclick = async () => {
  const text = document.getElementById("editInput").value.trim();
  if (!text || !editingId) return;
  const ref = doc(db, "chat", editingId);
  await updateDoc(ref, { text });
  editingId = null;
  document.getElementById("editInput").style.display = "none";
  document.getElementById("editSubmitBtn").style.display = "none";
  document.getElementById("editInput").value = "";
  loadChat();
};





async function loadChat() {
  const box = document.getElementById("chatBox");
  box.innerHTML = "";
  const snapshot = await getDocs(collection(db, "chat"));
  let lastColorIndex = -1;

  const chats = [];
  snapshot.forEach(docSnap => {
    chats.push({ id: docSnap.id, ...docSnap.data() });
  });

  chats.sort((a, b) => {
    if (a.pinned && !b.pinned) return -1;
    if (!a.pinned && b.pinned) return 1;
    return (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0);
  });

  for (const data of chats) {
    const id = data.id;
    const key = `liked_${id}`;
    const liked = localStorage.getItem(key) === "true";

    let colorIndex;
    do {
      colorIndex = Math.floor(Math.random() * pastelColors.length);
    } while (colorIndex === lastColorIndex);
    lastColorIndex = colorIndex;
    const cardColor = pastelColors[colorIndex];

    const div = document.createElement("div");
    div.className = "chat-card";
    if (data.pinned === true) div.classList.add("pinned-card");
    div.style.backgroundColor = cardColor;

    // 🔒 관리자 버튼 영역
    if (isAdmin) {
      const adminControls = document.createElement("div");
      adminControls.style.display = "flex";
      adminControls.style.justifyContent = "flex-end";
      adminControls.style.gap = "6px";
      adminControls.style.marginBottom = "8px";

      const pinBtn = document.createElement("button");
      pinBtn.className = "admin-button";
      pinBtn.textContent = data.pinned ? "고정 해제" : "고정";
      pinBtn.onclick = () => togglePin(id, !!data.pinned);

      const editBtn = document.createElement("button");
      editBtn.className = "admin-button";
      editBtn.textContent = "수정";
      editBtn.onclick = () => editChat(id, data.text.replace(/`/g, "\\`"));

      const delBtn = document.createElement("button");
      delBtn.className = "admin-button";
      delBtn.textContent = "삭제";
      delBtn.onclick = () => deleteChat(id);

      adminControls.appendChild(pinBtn);
      adminControls.appendChild(editBtn);
      adminControls.appendChild(delBtn);
      div.appendChild(adminControls);
    }

    // 닉네임/고정 마크
    const header = document.createElement("div");
    header.innerHTML = `<strong>${data.pinned ? "📌" : (data.nickname || "익명")}</strong>`;
    div.appendChild(header);

    // 본문 영역 (더보기/줄이기 포함)
    const textDiv = document.createElement("div");
    textDiv.className = "chat-text preview";
    textDiv.innerHTML = (data.text || "")
      .replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>")
      .replace(/~~(.+?)~~/g, '<span style="font-size: 12px; color: #888;">$1</span>')
      .replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank">$1</a>')
      .replace(/\n/g, "<br>");

    const toggle = document.createElement("div");
    toggle.className = "toggle-more";
    toggle.textContent = "더보기";
    toggle.addEventListener("click", (e) => {
      e.stopPropagation();
      textDiv.classList.toggle("expanded");
      textDiv.classList.toggle("preview");
      toggle.textContent = textDiv.classList.contains("expanded") ? "줄이기" : "더보기";
    });

    div.appendChild(textDiv);

    requestAnimationFrame(() => {
      if (textDiv.scrollHeight > textDiv.clientHeight + 4) {
        div.appendChild(toggle);
      }
    });

    // 하단 좋아요/시간 표시
    const footer = document.createElement("div");
    footer.className = "card-footer";
    footer.innerHTML = `
      <div style="display: flex; align-items: center; gap: 4px;">
        <button class="like-button ${liked ? "liked" : ""}" onclick="likeChat('${id}', this)">
          ${liked ? "💙" : "♡"}
        </button>
        <span class="like-count">${data.likes || 0}</span>
      </div>
      <div class="timestamp">${data.timestamp?.toDate ? new Date(data.timestamp.toDate()).toLocaleString("ko-KR", {
        year: "numeric", month: "2-digit", day: "2-digit",
        hour: "2-digit", minute: "2-digit"
      }) : ""}</div>
    `;

    div.appendChild(footer);
    box.appendChild(div);
  }

  box.scrollTop = box.scrollHeight;
}







window.deleteChat = async function(id) {
  const ok = confirm("삭제할까요?");
  if (!ok) return;
  await deleteDoc(doc(db, "chat", id));
  loadChat();
};
window.togglePin = async function(id, currentlyPinned) {
  const ref = doc(db, "chat", id);
  await updateDoc(ref, { pinned: !currentlyPinned });
  loadChat();
};

window.likeChat = async function(id, btn) {
  const key = `liked_${id}`;
  const ref = doc(db, "chat", id);
  const snap = await getDoc(ref);
  if (!snap.exists()) return;
  const data = snap.data();
  const countSpan = btn.nextElementSibling;
  let currentLikes = data.likes || 0;

  const liked = localStorage.getItem(key) === "true";
  if (liked) {
    await updateDoc(ref, { likes: currentLikes - 1 });
    localStorage.setItem(key, "false");
    btn.classList.remove("liked");
    btn.innerHTML = "♡";
    countSpan.textContent = currentLikes - 1;
  } else {
    await updateDoc(ref, { likes: currentLikes + 1 });
    localStorage.setItem(key, "true");
    btn.classList.add("liked");
    btn.innerHTML = "💙";
    countSpan.textContent = currentLikes + 1;
  }
};
window.editChat = function(id, currentText) {
  const editBox = document.getElementById("editInput");
  const editBtn = document.getElementById("editSubmitBtn");
  editingId = id;
  editBox.value = currentText;
  editBox.style.display = "block";
  editBtn.style.display = "inline-block";
};



document.getElementById("adminBtn").onclick = async () => {
  const pwd = prompt("비밀번호를 입력하세요");
  if (!pwd) return;
  const snap = await getDoc(doc(db, "admin", "secret"));
  if (!snap.exists()) return alert("비밀번호 데이터 없음");
  const real = snap.data().password;
  if (pwd === real) {
    isAdmin = true;
    loadChat();
    alert("관리자 권한이 활성화되었습니다.");
  } else {
    alert("비밀번호가 틀렸습니다.");
  }
};

loadChat();
const chatInput = document.getElementById("chatInput");

chatInput.addEventListener("input", function () {
  this.style.height = "auto";
  this.style.height = this.scrollHeight + "px";
});
const editInput = document.getElementById("editInput");
editInput.addEventListener("input", function () {
  this.style.height = "auto";
  this.style.height = this.scrollHeight + "px";
});

</script>
</body>
</html>
