<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>이재명 정부 성공을 위한 자료 모음 💙</title>
<style>
  body {
    font-family: "Malgun Gothic", sans-serif;
    background-color: #f2f5f8;
    margin: 0;
    padding: 0;
    font-size: 14px;
  }
  .page-title {
    max-width: 700px;
    margin: 30px auto 20px;
    text-align: center;
    padding: 0 15px;
    line-height: 1.6;
    user-select: text;
  }
  .page-title .main-title {
    font-size: 30px;
    font-weight: bold;
  }
  .page-title .sub-title {
    font-size: 13px;
    font-weight: normal;
  }
  .chat-container {
    width: 100%;
    max-width: 500px;
    box-sizing: border-box;
    height: 600px;
    overflow-y: auto;
    margin: 0 auto;
    padding: 10px;
    background-color: #e0f3ff;
    border-radius: 15px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
  }
  
.chat-card {
  max-width: 100%;
  padding: 16px;
  margin: 12px auto;
  border-radius: 12px;
  background-color: #ffffff;
  border: 1px solid #ccc;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  font-size: 14px;
  line-height: 1.6;
  position: relative;
  word-wrap: break-word;
  box-sizing: border-box;

  text-align: left;}

  .timestamp {
    font-size: 12px;
    color: #888;
    text-align: right;
    margin-top: 4px;
  }
  .bubble-buttons {
    display: none;
    font-size: 12px;
    margin-top: 6px;
    text-align: right;
  }
  .search-bar, #input-area, #admin-panel {
    max-width: 500px;
    margin: 20px auto;
    text-align: center;
  }
  .search-bar input {
    width: 100%;
    max-width: 333px;
    margin: 0 auto;
    display: block;
    padding: 8px 12px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 8px;
  }
  button {
    margin-top: 10px;
    padding: 6px 12px;
    font-size: 14px;
    border-radius: 8px;
    border: none;
    background-color: #aaa;
    color: white;
    cursor: pointer;
  }
  button:hover {
    background-color: #888;
  }
  #toast {
    display: none;
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #333;
    color: #fff;
    padding: 10px 16px;
    border-radius: 20px;
    font-size: 14px;
    opacity: 0.9;
    z-index: 1000;
  }
  .chat-content.preview .inner-text {
    max-height: 4.5em;
    overflow: hidden;
  }
  .chat-content.expanded .inner-text {
    max-height: none;
  }
  .chat-content .inner-text {
    transition: max-height 0.3s ease;
    user-select: text;
  }
</style>
</head>
<body>
<div class="page-title">
<div class="main-title">이재명 정부 성공을 위한 자료 모음 💙</div>
<br/>
<div style="font-size: 12px; color: #333; text-align: center; margin: 0 auto 10px;">
외부 공유 가능합니다.<br><br>
  ‘검찰개혁 4법’ 추석 전 통과를 위한 전국민 백만 서명운동 - 
  <a href="https://docs.google.com/forms/d/e/1FAIpQLScAiT3buFKXh5-Wagzh3uxNjJnnoZ6lmU8eNShsU-Xpmqmhkg/viewform" target="_blank" style="color: #1a0dab; text-decoration: underline;">서명 링크 이동
  </a>
</div>


  <div class="search-bar" style="display: flex; justify-content: center; gap: 8px; flex-wrap: wrap;">
  <select id="prefixFilter" onchange="filterMessages()" 
    style="flex: 0 0 auto; max-width: 120px; padding: 8px 12px; font-size: 14px; border: 1px solid #ccc; border-radius: 8px;">
    <option value="">전체 보기</option>
    <option value="💡 팩트 정리">💡 팩트 정리</option>
    <option value="🔵 박찬대 밭갈이용">🔵 박찬대 밭갈이용</option>
    <option value="🔔 참고">🔔 참고</option>
    <option value="📌 인사 관련">📌 인사 관련</option>
  </select>

  <input id="searchInput" oninput="filterMessages()" placeholder="내용 검색" type="text"
    style="flex: 1 1 auto; min-width: 0; padding: 8px 12px; font-size: 14px; border: 1px solid #ccc; border-radius: 8px; max-width: 340px;" />
</div>

<div class="chat-container" id="chatBox"></div>
<div id="admin-panel"><button onclick="showPasswordPrompt()">🔒 관리자 전용</button></div>
<div id="visit-count" style="text-align:center; font-size:13px; color:#555; margin-top:12px;">
  방문자 수를 불러오는 중...
</div>

<div id="input-area" style="display:none;">
  <select id="prefix" style="width: 100%; max-width: 500px; margin-bottom: 8px; padding: 6px; font-size: 14px;">
    <option value="">전체 보기</option>
    <option value="💡 팩트 정리">💡 팩트 정리</option>
    <option value="🔵 박찬대 밭갈이용">🔵 박찬대 밭갈이용</option>
    <option value="🔔 참고">🔔 참고</option>
    <option value="📌 인사 관련">📌 인사 관련</option>
  </select>
  <textarea id="newMessage" placeholder="내용" rows="3" style="width: 100%; height: 160px; box-sizing: border-box; overflow-y: auto;"></textarea>
  <br/>
  <button onclick="addOrUpdateMessage()">내용 추가</button>
</div>
<div id="toast">📋 복사</div>


<div style="font-size: 12px; color: #333; text-align: center; margin: 0 auto 10px;">
업로드 요청 : 
  <a href="https://cafe.daum.net/subdued20club/VrjL/940638" target="_blank" style="color: #1a0dab; text-decoration: underline;">링크 이동</a>
</div>





<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  addDoc,
  deleteDoc,
  updateDoc,
  doc,
  getDoc,
  setDoc,
  serverTimestamp,
  query,
  orderBy
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";



const firebaseConfig = {
  apiKey: "AIzaSyAZHqkGXdH4XxL-0jprA2DB7YO4XhTdNmQ",
  authDomain: "chat-page-6d547.firebaseapp.com",
  projectId: "chat-page-6d547",
  storageBucket: "chat-page-6d547.appspot.com",
  messagingSenderId: "1087235341754",
  appId: "1:1087235341754:web:6583340a62f21068b5b183"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let isAdmin = false;
let editingId = null;

async function loadMessages() {
  const container = document.getElementById("chatBox");
  container.innerHTML = "";
  const q = query(collection(db, "message"), orderBy("timestamp", "asc"));
  
    function copyTextToClipboard(text) {
      const textarea = document.createElement("textarea");
      textarea.value = text;
      textarea.setAttribute("readonly", "");
      textarea.style.position = "absolute";
      textarea.style.left = "-9999px";
      document.body.appendChild(textarea);
      textarea.select();
      try {
        document.execCommand("copy");
        const toast = document.getElementById("toast");
        toast.style.display = "block";
        setTimeout(() => toast.style.display = "none", 1500);
      } catch (err) {
        console.error("복사 실패", err);
      }
      document.body.removeChild(textarea);
    }

  
  const snapshot = await getDocs(q);
  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    const id = docSnap.id;
    const msg = data.content;
    const prefix = data.prefix || "";
    const ts = data.timestamp ? data.timestamp.toDate() : new Date();
    const dateOnly = ts.getFullYear() + '-' + String(ts.getMonth()+1).padStart(2, '0') + '-' + String(ts.getDate()).padStart(2, '0');

    const bubble = document.createElement("div");
    bubble.className = "chat-card";

    const contentDiv = document.createElement("div");
    contentDiv.className = "chat-content preview";

    const inner = document.createElement("div");
    inner.className = "inner-text";
    inner.innerHTML = `${prefix ? `<strong>${prefix}</strong><br>` : ""}` + msg.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>').replace(/\n/g, '<br>');

    const toggle = document.createElement("div");
    toggle.className = "toggle-more";
    toggle.textContent = "더보기";
    toggle.style.cssText = "text-align:right; font-size:12px; color:gray; cursor:pointer;";
    toggle.addEventListener("click", (event) => {
      event.stopPropagation();
      contentDiv.classList.toggle("expanded");
      toggle.textContent = contentDiv.classList.contains("expanded") ? "줄이기" : "더보기";
    });

    contentDiv.appendChild(inner);

    requestAnimationFrame(() => {
      const oldToggle = contentDiv.querySelector(".toggle-more");
      if (oldToggle) oldToggle.remove();

      const isOverflowed = inner.scrollHeight > inner.clientHeight + 4;
      if (isOverflowed) {
        const toggle = document.createElement("div");
        toggle.className = "toggle-more";
        toggle.textContent = "더보기";
        toggle.style.cssText = "text-align:right; font-size:12px; color:gray; cursor:pointer;";
        toggle.addEventListener("click", (event) => {
          event.stopPropagation();
          contentDiv.classList.toggle("expanded");
          toggle.textContent = contentDiv.classList.contains("expanded") ? "줄이기" : "더보기";
        });
        contentDiv.appendChild(toggle);
      }
    });


    // PC 클릭 복사
    

    
    
    
    
    // 복사 버튼 추가
    const copyBtn = document.createElement("button");
    copyBtn.textContent = "복사";
    copyBtn.style.cssText = "position: absolute; bottom: 5px; left: 10px; font-size: 12px; padding: 4px 8px; border-radius: 6px; background-color: #eee; color: #000; border: none; cursor: pointer;";
    copyBtn.onclick = () => {
      // 말머리를 제거한 텍스트 추출
      let raw = inner.innerText.trim();
      if (raw.startsWith("💡") || raw.startsWith("🔵") || raw.startsWith("🔔")) {
        raw = raw.substring(raw.indexOf("\n") + 1).trim();
      }
      const textarea = document.createElement("textarea");
      textarea.value = raw;
      textarea.setAttribute("readonly", "");
      textarea.style.position = "absolute";
      textarea.style.left = "-9999px";
      document.body.appendChild(textarea);
      textarea.select();
      try {
        document.execCommand("copy");
        const toast = document.getElementById("toast");
        toast.textContent = "📋 복사 완료";
        toast.style.display = "block";
        setTimeout(() => toast.style.display = "none", 1500);
      } catch (err) {
        console.error("복사 실패", err);
      }
      document.body.removeChild(textarea);
    };
    contentDiv.appendChild(copyBtn);




    contentDiv.appendChild(toggle);
    bubble.appendChild(contentDiv);

    const tsDiv = document.createElement("div");
    tsDiv.className = "timestamp";
    tsDiv.textContent = dateOnly;
    bubble.appendChild(tsDiv);

    if (isAdmin) {
      const btns = document.createElement("div");
      btns.className = "bubble-buttons";
      btns.style.display = "block";
      const editBtn = document.createElement("button");
      editBtn.textContent = "수정";
      editBtn.onclick = () => {
        document.getElementById("newMessage").value = msg;
        document.getElementById("prefix").value = prefix;
        editingId = id;
      };




const delBtn = document.createElement("button");
delBtn.textContent = "삭제";
delBtn.onclick = async () => {
  const ok = confirm("정말 삭제하시겠습니까?");
  if (!ok) return; // 사용자가 '아니오'를 누르면 취소
  await deleteDoc(doc(db, "message", id));
  loadMessages();
};




      btns.appendChild(editBtn);
      btns.appendChild(delBtn);
      bubble.appendChild(btns);
    }

    container.appendChild(bubble);
  });
  container.scrollTop = container.scrollHeight;
filterMessages(); // ← 이거 추가!

}

async function addOrUpdateMessage() {
  const content = document.getElementById("newMessage").value.trim();
  const prefix = document.getElementById("prefix").value;
  if (!content) return;
  if (editingId) {
    await updateDoc(doc(db, "message", editingId), { content, prefix });
    editingId = null;
  } else {
    await addDoc(collection(db, "message"), { content, prefix, timestamp: serverTimestamp() });
  }
  document.getElementById("newMessage").value = "";
  loadMessages();
}


async function showPasswordPrompt() {
  const pwd = prompt("비밀번호를 입력하세요");
  if (!pwd) return;

  try {
    const docRef = doc(db, "admin", "secret");
    const docSnap = await getDoc(docRef);
    if (!docSnap.exists()) {
      alert("비밀번호 데이터가 존재하지 않습니다.");
      return;
    }

    const realPassword = docSnap.data().password;
    if (pwd === realPassword) {
      isAdmin = true;
      document.getElementById("input-area").style.display = "block";
      loadMessages();
    } else {
      alert("비밀번호가 틀렸습니다.");
    }
  } catch (error) {
    console.error("비밀번호 확인 중 오류 발생:", error);
    alert("오류가 발생했습니다.");
  }
}


function filterMessages() {
  const queryText = document.getElementById("searchInput").value.toLowerCase();
  const selectedPrefix = document.getElementById("prefixFilter")?.value || "";
  const bubbles = document.querySelectorAll(".chat-card");
  bubbles.forEach(b => {
    const text = b.textContent.toLowerCase();
    const prefixMatch = selectedPrefix === "" || text.includes(selectedPrefix.toLowerCase());
    const textMatch = text.includes(queryText);
    b.style.display = (prefixMatch && textMatch) ? "block" : "none";
  });
}

window.addOrUpdateMessage = addOrUpdateMessage;
window.showPasswordPrompt = showPasswordPrompt;
window.filterMessages = filterMessages;
window.onload = loadMessages;




async function countVisitor() {
  const todayKey = new Date().toISOString().split('T')[0];
  const visited = localStorage.getItem('visited_' + todayKey);

  if (visited) {
    getVisitorCount();
    return;
  }

  const counterRef = doc(db, "visit_count", "counter");
  const snap = await getDoc(counterRef);
  if (snap.exists()) {
    const current = snap.data().total || 0;
    await setDoc(counterRef, { total: current + 1 });
    displayVisitorCount(current + 1);
  } else {
    await setDoc(counterRef, { total: 1 });
    displayVisitorCount(1);
  }

  localStorage.setItem('visited_' + todayKey, 'true');
}

async function getVisitorCount() {
  const counterRef = doc(db, "visit_count", "counter");
  const snap = await getDoc(counterRef);
  if (snap.exists()) {
    const current = snap.data().total || 0;
    displayVisitorCount(current);
  }
}





function displayVisitorCount(count) {
  const visitDiv = document.getElementById("visit-count");
  if (visitDiv) {
    visitDiv.textContent = `총 방문자 수: ${count.toLocaleString()}명`;
  }
}

countVisitor(); // 페이지 열릴 때 실행







</script>



</body>
</html>