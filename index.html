<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>ë¯¼ì£¼ì£¼ì˜ë¥¼ ìœ„í•œ ìë£Œ ëª¨ìŒ ğŸ’™</title>
<style>
  body {
    font-family: "Malgun Gothic", sans-serif;
    background-color: #f2f5f8;
    margin: 0;
    padding: 0;
    font-size: 14px;
  }
  .page-title {
    max-width: 700px;
    margin: 25px auto 20px;
    text-align: center;
    padding: 0 15px;
    line-height: 1.6;
    user-select: text;
  }
  .page-title .main-title {
    font-size: 20px;
    font-weight: bold;
  }
  .page-title .sub-title {
    font-size: 13px;
    font-weight: normal;
  }
  .chat-container {
    width: 100%;
    max-width: 500px;
    box-sizing: border-box;
    height: 600px;
    overflow-y: auto;
    margin: 0 auto;
    padding: 10px;
    background-color: #e0f3ff;
    border-radius: 15px;
    padding-bottom: 20px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
  }
  
.chat-card {
  max-width: 100%;
  padding: 16px;
  margin: 20px auto;
  border-radius: 12px;
  background-color: #ffffff;
  border: 1px solid #ccc;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  font-size: 14px;
  line-height: 1.6;
  position: relative;
  word-wrap: break-word;
  box-sizing: border-box;
  text-align: left;}
  .timestamp {
    font-size: 12px;
    color: #888;
    text-align: right;
    margin-top: 4px;
  }
  .bubble-buttons {
    display: none;
    font-size: 12px;
    margin-top: 6px;
    text-align: right;
  }
  .search-bar, #input-area, #admin-panel {
    max-width: 500px;
    margin: 20px auto;
    text-align: center;
  }
  .search-bar input {
    width: 100%;
    max-width: 333px;
    margin: 0 auto;
    display: block;
    padding: 8px 12px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 8px;
  }
  button {
    margin-top: 10px;
    padding: 6px 12px;
    font-size: 14px;
    border-radius: 8px;
    border: none;
    background-color: #aaa;
    color: white;
    cursor: pointer;
  }
  button:hover {
    background-color: #888;
  }
  #toast {
    display: none;
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #333;
    color: #fff;
    padding: 10px 16px;
    border-radius: 20px;
    font-size: 14px;
    opacity: 0.9;
    z-index: 1000;
  }
  .chat-content.preview .inner-text {
    max-height: 7.3em;
    overflow: hidden;
  }
  .chat-content.expanded .inner-text {
    max-height: none;
  }
.chat-content .inner-text {
  transition: max-height 0.3s ease;
  user-select: text;
  font-size: 12px; /* ë³¸ë¬¸ ë‚´ìš© í°íŠ¸ í¬ê¸° */
}
.chat-content .inner-text strong:not(.prefix-tag) {
  margin-bottom: 0;
  display: inline;         /* ì¸ë¼ì¸ ìš”ì†Œë¡œ ê°•ì œ */
  line-height: normal;     /* ë¼ì¸ ë°•ìŠ¤ ë†’ì´ ìµœì†Œí™” */
}

.chat-content .inner-text > strong {
  font-size: 14px;
  display: inline-block;
  margin-bottom: 10px;
  /* ë°‘ì¤„ ì œê±° */
}

/* ë§ë¨¸ë¦¬ì—ë§Œ ì„  ì ìš© */
.prefix-tag {
  border-bottom: 1px dashed #ccc;
  padding-bottom: 2px;
}



@keyframes sparkle {
  0%   { opacity: 1; text-shadow: 0 0 5px #3399ff; }
  50%  { opacity: 0.6; text-shadow: 0 0 12px #66ccff; }
  100% { opacity: 1; text-shadow: 0 0 5px #3399ff; }
}
.sparkling-text {
  animation: sparkle 1.5s infinite;
  font-weight: bold;
  color: #007bff;
}
</style>
</head>
<body>
<div id="toast">ğŸ“‹ ë³µì‚¬</div>
<div class="page-title">
<div class="main-title">ë¯¼ì£¼ì£¼ì˜ë¥¼ ìœ„í•œ ìë£Œ ëª¨ìŒ ğŸ’™</div>
<br/>
<div class="chat-container" id="chatBox"></div>
<div class="search-bar" style="display: flex; justify-content: center; gap: 8px; flex-wrap: wrap;">
  <select id="prefixFilter" onchange="filterMessages()" 
    style="flex: 0 0 auto; max-width: 120px; padding: 8px 12px; font-size: 14px; border: 1px solid #ccc; border-radius: 8px;">
    <option value="">ì „ì²´ ë³´ê¸°</option>
    <option value="ğŸ“£ íŒ©íŠ¸ ì²´í¬">ğŸ“£ íŒ©íŠ¸ ì²´í¬</option>
    <option value="ğŸ”” ì°¸ê³  ìë£Œ">ğŸ”” ì°¸ê³  ìë£Œ</option>
    <option value="ğŸ€ ì •ì±… ë°˜ì‘">ğŸ€ ì •ì±… ë°˜ì‘</option>
    <option value="ğŸ”µ ë°•ì°¬ëŒ€ ë‹¹ëŒ€í‘œ">ğŸ”µ ë°•ì°¬ëŒ€ ë‹¹ëŒ€í‘œ</option>
    <option value="âœ¨í¬ì§€í‹°ë¸Œ ëŒ“ê¸€">âœ¨í¬ì§€í‹°ë¸Œ ëŒ“ê¸€</option>
<option value="ğŸ’¬ì±„íŒ…ìš© í•œ ì¤„(ëœë¤ ë³µì‚¬)">ğŸ’¬ì±„íŒ…ìš© í•œ ì¤„(ëœë¤ ë³µì‚¬)</option>

  </select>
  <input id="searchInput" oninput="filterMessages()" placeholder="ë‚´ìš© ê²€ìƒ‰" type="text"
    style="flex: 1 1 auto; min-width: 0; padding: 8px 12px; font-size: 14px; font-family: 'Malgun Gothic', sans-serif; border: 1px solid #ccc; border-radius: 8px; max-width: 340px;" />
</div>
<div id="admin-panel" style="display: flex; justify-content: center; gap: 10px;">
<button id="uploadRequestBtn" style="background-color: #fae100; color: #000; border: none; padding: 8px 12px; border-radius: 6px;">âœ‰ï¸ ì—…ë¡œë“œ ìš”ì²­</button>
  <button onclick="showPasswordPrompt()">ğŸ”’ ê´€ë¦¬ì ì „ìš©</button>
</div>
<hr style="margin: 20px 0; border: none; border-top: 1px solid #ccc;" />
<div style="text-align:center; font-size:20px; margin-bottom:10px;">
  <strong class="sparkling-text">ì™¸ë¶€ ê³µìœ  í™˜ì˜</strong>
</div>
<!-- âœ… 1. í•­ìƒ ë³´ì´ê²Œ í•  status-bar (visitor-message-box ë°”ê¹¥ì— ìœ„ì¹˜) -->
<div id="status-bar" style="display:flex; justify-content:center; gap:20px; font-size:13px; color:#555; margin-top:12px;">
  <div id="upload-count">ì˜¤ëŠ˜ ì—…ë¡œë“œ ìš”ì²­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  <div id="visit-count">ë°©ë¬¸ì ìˆ˜ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
</div>

<!-- âœ… 2. ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê²¨ì§€ëŠ” ì—…ë¡œë“œ ìš”ì²­ ë°•ìŠ¤ -->
<div id="visitor-message-box" style="display:none; flex-direction: column; align-items: center; max-width: 500px; margin: 10px auto;">
  <textarea id="visitorMessage" placeholder="ê´€ë¦¬ìì—ê²Œ ì—…ë¡œë“œ ìš”ì²­í•  ìë£Œ ë§í¬ë¥¼ ì£¼ì„¸ìš”.(ê°€ê¸‰ì  ë¡œê·¸ì¸ ì—†ì´ ë³¼ ìˆ˜ ìˆëŠ” ìë£Œë¡œ)" rows="4" style="width: 100%; padding: 8px; font-size: 14px; font-family: 'Malgun Gothic', sans-serif;"></textarea>
  <button onclick="submitVisitorMessage()" style="background-color: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 6px;">ğŸ“© ë©”ì‹œì§€ ë³´ë‚´ê¸°</button>
</div>

<div id="input-area" style="display:none;">
  <select id="prefix" style="width: 100%; max-width: 500px; margin-bottom: 8px; padding: 6px; font-size: 14px;">
    <option value="">ì „ì²´ ë³´ê¸°</option>
    <option value="ğŸ“£ íŒ©íŠ¸ ì²´í¬">ğŸ“£ íŒ©íŠ¸ ì²´í¬</option>
    <option value="ğŸ”” ì°¸ê³  ìë£Œ">ğŸ”” ì°¸ê³  ìë£Œ</option>
    <option value="ğŸ€ ì •ì±… ë°˜ì‘">ğŸ€ ì •ì±… ë°˜ì‘</option>
    <option value="ğŸ”µ ë°•ì°¬ëŒ€ ë‹¹ëŒ€í‘œ">ğŸ”µ ë°•ì°¬ëŒ€ ë‹¹ëŒ€í‘œ</option>
    <option value="âœ¨í¬ì§€í‹°ë¸Œ ëŒ“ê¸€">âœ¨í¬ì§€í‹°ë¸Œ ëŒ“ê¸€</option>
<option value="ğŸ’¬ì±„íŒ…ìš© í•œ ì¤„(ëœë¤ ë³µì‚¬)">ğŸ’¬ì±„íŒ…ìš© í•œ ì¤„(ëœë¤ ë³µì‚¬)</option>

  </select>
  <textarea id="newMessage" placeholder="ë‚´ìš©" rows="3" style="width: 100%; height: 160px; box-sizing: border-box; overflow-y: auto;font-family: 'Malgun Gothic', sans-serif;"></textarea>
  <br/>
  <button onclick="addOrUpdateMessage()">ë‚´ìš© ì¶”ê°€</button>
<hr style="margin: 20px 0; border: none; border-top: 1px solid #ccc;" />
<div id="visitor-messages" style="margin-top: 20px;">
  <h4 style="text-align:left; font-size:16px;">ğŸ“¨ ë°©ë¬¸ì ë©”ì‹œì§€</h4>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  addDoc,
  deleteDoc,
  updateDoc,
  doc,
  getDoc,
  setDoc,
  serverTimestamp,
  query,
  orderBy
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
const firebaseConfig = {
  apiKey: "AIzaSyAZHqkGXdH4XxL-0jprA2DB7YO4XhTdNmQ",
  authDomain: "chat-page-6d547.firebaseapp.com",
  projectId: "chat-page-6d547",
  storageBucket: "chat-page-6d547.appspot.com",
  messagingSenderId: "1087235341754",
  appId: "1:1087235341754:web:6583340a62f21068b5b183"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
let isAdmin = false;
let editingId = null;

async function loadMessages() {
  const container = document.getElementById("chatBox");
const previousScrollTop = container.scrollTop;
  container.innerHTML = "";

  const q = query(collection(db, "message"), orderBy("timestamp", "asc"));
  
    function copyTextToClipboard(text) {
      const textarea = document.createElement("textarea");
      textarea.value = text;
      textarea.setAttribute("readonly", "");
      textarea.style.position = "absolute";
      textarea.style.left = "-9999px";
      document.body.appendChild(textarea);
      textarea.select();
      try {
        document.execCommand("copy");
        const toast = document.getElementById("toast");
        toast.style.display = "block";
        setTimeout(() => toast.style.display = "none", 1500);
      } catch (err) {
        console.error("ë³µì‚¬ ì‹¤íŒ¨", err);
      }
      document.body.removeChild(textarea);
    }
  
  const snapshot = await getDocs(q);
  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    const id = docSnap.id;
    const msg = data.content;
    const prefix = data.prefix || "";
const ts = data.timestamp ? data.timestamp.toDate() : new Date();
const yearShort = String(ts.getFullYear()).slice(2); 
const dateOnly = yearShort + '-' + String(ts.getMonth()+1).padStart(2, '0') + '-' + String(ts.getDate()).padStart(2, '0');
    const bubble = document.createElement("div");
    bubble.className = "chat-card";
    const contentDiv = document.createElement("div");
    contentDiv.className = "chat-content preview";
    const inner = document.createElement("div");
    inner.className = "inner-text";


const keywordStyles = [
  { word: "[ì§€ì§€ ì„ ì–¸]", color: "#007bff" },     // íŒŒë€ìƒ‰
  { word: "[í•¨ê»˜í•˜ëŠ” ì‚¬ëŒë“¤]", color: "#28a745" }, // ì´ˆë¡ìƒ‰
  { word: "[ì •ë³´]", color: "#6f42c1" },          // ë³´ë¼ìƒ‰
  { word: "[ë°­ê°ˆì´]", color: "#dc3545" },          // ë¹¨ê°•ìƒ‰
  { word: "[ì¸ì‚¬ ê´€ë ¨]", color: "#dc3545" },          // ë¹¨ê°•ìƒ‰
];

function escapeRegExp(str) {
  return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

let highlightedMsg = msg;
keywordStyles.forEach(({ word, color }) => {
  const regex = new RegExp(escapeRegExp(word), 'g');
  highlightedMsg = highlightedMsg.replace(
    regex,
    `<span style="font-weight: bold; color: ${color}; font-size: 13px;">${word}</span>`
  );
});




let formattedMsg = "";

if (prefix === "ğŸ’¬ì±„íŒ…ìš© í•œ ì¤„(ëœë¤ ë³µì‚¬)") {
  const lines = highlightedMsg.split('\n');
  formattedMsg = lines.map((line, idx) => {
    const color = idx % 2 === 0 ? '#000000' : '#888888'; // í™€ìˆ˜ ì¤„ì€ ê²€ì •, ì§ìˆ˜ ì¤„ì€ íšŒìƒ‰
    return `<span style="color: ${color};">${line}</span>`;
  }).join('<br>');
} else {
  formattedMsg = highlightedMsg.replace(/\n/g, '<br>');
}

// ê³µí†µ í›„ì²˜ë¦¬

formattedMsg = highlightedMsg
  .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
  .replace(/~~(.+?)~~/g, '<span style="font-size: 12px; color: #888;">$1</span>')
  .replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank">$1</a>')
  .replace(/\n/g, '<br>'); // ğŸ”¥ ì´ ì¤„ ì¶”ê°€!





inner.innerHTML = `${prefix ? `<strong class="prefix-tag">${prefix}</strong><br>` : ""}` + formattedMsg;






    const toggle = document.createElement("div");
    toggle.className = "toggle-more";
    toggle.textContent = "ë”ë³´ê¸°";
    toggle.style.cssText = "text-align:right; font-size:12px; color:gray; cursor:pointer;";
    toggle.addEventListener("click", (event) => {
      event.stopPropagation();
      contentDiv.classList.toggle("expanded");
      toggle.textContent = contentDiv.classList.contains("expanded") ? "ì¤„ì´ê¸°" : "ë”ë³´ê¸°";
    });
    contentDiv.appendChild(inner);
    requestAnimationFrame(() => {
      const oldToggle = contentDiv.querySelector(".toggle-more");
      if (oldToggle) oldToggle.remove();
      const isOverflowed = inner.scrollHeight > inner.clientHeight + 4;
      if (isOverflowed) {
        const toggle = document.createElement("div");
        toggle.className = "toggle-more";
        toggle.textContent = "ë”ë³´ê¸°";
        toggle.style.cssText = "text-align:right; font-size:12px; color:gray; cursor:pointer;";
        toggle.addEventListener("click", (event) => {
          event.stopPropagation();
          contentDiv.classList.toggle("expanded");
          toggle.textContent = contentDiv.classList.contains("expanded") ? "ì¤„ì´ê¸°" : "ë”ë³´ê¸°";
        });
        contentDiv.appendChild(toggle);
      }
    });
    const copyBtn = document.createElement("button");
    copyBtn.textContent = "ë³µì‚¬";
    copyBtn.style.cssText = "position: absolute; bottom: 5px; left: 10px; font-size: 12px; padding: 4px 8px; border-radius: 6px; background-color: #eee; color: #000; border: none; cursor: pointer;";








copyBtn.onclick = () => {
  let raw = inner.innerText.trim();

  // ë§ë¨¸ë¦¬ ì œê±°
  if (
    raw.startsWith("ğŸ“£") ||
    raw.startsWith("ğŸ””") ||
    raw.startsWith("ğŸ€") ||
    raw.startsWith("ğŸ”µ") ||
    raw.startsWith("âœ¨") ||
    raw.startsWith("ğŸ’¬")
  ) {
    raw = raw.substring(raw.indexOf("\n") + 1).trim();
  }

  // ğŸ’¬ì±„íŒ…ìš© í•œ ì¤„ì¸ ê²½ìš°: í•œ ì¤„ë§Œ ëœë¤ìœ¼ë¡œ ë³µì‚¬


if (prefix === "ğŸ’¬ì±„íŒ…ìš© í•œ ì¤„(ëœë¤ ë³µì‚¬)") {
  const lines = raw.split("\n").filter(line => line.trim() !== "");
  if (lines.length > 0) {
    raw = lines[Math.floor(Math.random() * lines.length)];
  }
}


  const textarea = document.createElement("textarea");
  textarea.value = raw;
  textarea.setAttribute("readonly", "");
  textarea.style.position = "absolute";
  textarea.style.left = "-9999px";
  document.body.appendChild(textarea);
  textarea.select();
  try {
    document.execCommand("copy");
    const toast = document.getElementById("toast");
    toast.style.display = "block";
    setTimeout(() => toast.style.display = "none", 1500);
  } catch (err) {
    console.error("ë³µì‚¬ ì‹¤íŒ¨", err);
  }
  document.body.removeChild(textarea);
};










    contentDiv.appendChild(copyBtn);
    bubble.appendChild(contentDiv);
    const tsDiv = document.createElement("div");
    tsDiv.className = "timestamp";
    tsDiv.textContent = dateOnly;
    bubble.appendChild(tsDiv);
    if (isAdmin) {
      const btns = document.createElement("div");
      btns.className = "bubble-buttons";
      btns.style.display = "block";
      const editBtn = document.createElement("button");
      editBtn.textContent = "ìˆ˜ì •";
      editBtn.onclick = () => {
        document.getElementById("newMessage").value = msg;
        document.getElementById("prefix").value = prefix;
        editingId = id;
      };
const delBtn = document.createElement("button");
delBtn.textContent = "ì‚­ì œ";
delBtn.onclick = async () => {
  const ok = confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
  if (!ok) return; 
  await deleteDoc(doc(db, "message", id));
  loadMessages();
};
      btns.appendChild(editBtn);
      btns.appendChild(delBtn);
      bubble.appendChild(btns);
    }
    container.appendChild(bubble);
  });

filterMessages(); 
container.scrollTop = container.scrollHeight;


if (isAdmin) {
  const visitorContainer = document.getElementById("visitor-messages");
  if (visitorContainer) {
    const visitorSnap = await getDocs(query(collection(db, "visitor_requests"), orderBy("timestamp", "desc")));
    visitorSnap.forEach(docSnap => {
      const data = docSnap.data();
      const ts = data.timestamp ? data.timestamp.toDate() : new Date();
const id = docSnap.id;
const dateOnly = `${String(ts.getFullYear()).slice(2)}-${String(ts.getMonth()+1).padStart(2, '0')}-${String(ts.getDate()).padStart(2, '0')} ${String(ts.getHours()).padStart(2, '0')}:${String(ts.getMinutes()).padStart(2, '0')}`;
      const bubble = document.createElement("div");
      bubble.className = "chat-card";
      bubble.style.backgroundColor = "#fff4e6";
bubble.style.position = "relative";
if (isAdmin) {
  const delBtn = document.createElement("div");
  delBtn.textContent = "âŒ";
  delBtn.style.cssText = `
    position: absolute;
    top: 8px;
    right: 12px;
    cursor: pointer;
    font-size: 14px;
    color: red;
  `;
  delBtn.title = "ì‚­ì œ";
delBtn.onclick = async () => {
  const ok = confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
  if (!ok) return;
  await deleteDoc(doc(db, "visitor_requests", id));
  bubble.remove(); 
};
  bubble.appendChild(delBtn);
}      


const content = document.createElement("div");
content.className = "chat-content";

// ë§í¬ ìë™ ë³€í™˜ ë° ì¤„ë°”ê¿ˆ


const linkifiedContent = data.content
  .replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" style="color:#1a0dab; text-decoration: underline;">$1</a>')  // ìˆ˜ì •ë¨
  .replace(/\n/g, "<br>");



content.innerHTML = `<strong>ğŸ“© ë°©ë¬¸ì ë©”ì‹œì§€</strong><br><div class="inner-text">${linkifiedContent}</div>`;

// ë³µì‚¬ ë²„íŠ¼ ì¶”ê°€
const copyBtn = document.createElement("button");
copyBtn.textContent = "ë³µì‚¬";
copyBtn.style.cssText = "position: absolute; bottom: 5px; left: 10px; font-size: 12px; padding: 4px 8px; border-radius: 6px; background-color: #eee; color: #000; border: none; cursor: pointer;";

copyBtn.onclick = () => {
  const rawText = data.content.trim();
  const textarea = document.createElement("textarea");
  textarea.value = rawText;
  textarea.setAttribute("readonly", "");
  textarea.style.position = "absolute";
  textarea.style.left = "-9999px";
  document.body.appendChild(textarea);
  textarea.select();
  try {
    document.execCommand("copy");
    const toast = document.getElementById("toast");
    toast.style.display = "block";
    setTimeout(() => (toast.style.display = "none"), 1500);
  } catch (err) {
    console.error("ë³µì‚¬ ì‹¤íŒ¨", err);
  }
  document.body.removeChild(textarea);
};

bubble.appendChild(copyBtn);







      const tsDiv = document.createElement("div");
      tsDiv.className = "timestamp";
      tsDiv.textContent = dateOnly;
      bubble.appendChild(content);
      bubble.appendChild(tsDiv);
      visitorContainer.appendChild(bubble);
    });
  }
}}async function addOrUpdateMessage() {
  const content = document.getElementById("newMessage").value.trim();
  const prefix = document.getElementById("prefix").value;
  if (!content) return;
  if (editingId) {
    await updateDoc(doc(db, "message", editingId), { content, prefix });
    editingId = null;
  } else {
    await addDoc(collection(db, "message"), { content, prefix, timestamp: serverTimestamp() });
  }
  document.getElementById("newMessage").value = "";
  loadMessages();
}async function showPasswordPrompt() {
  const pwd = prompt("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
  if (!pwd) return;
  try {
    const docRef = doc(db, "admin", "secret");
    const docSnap = await getDoc(docRef);
    if (!docSnap.exists()) {
      alert("ë¹„ë°€ë²ˆí˜¸ ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      return;
    }
    const realPassword = docSnap.data().password;
    if (pwd === realPassword) {
      isAdmin = true;
      document.getElementById("input-area").style.display = "block";
      loadMessages();
    } else {
      alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
    }
  } catch (error) {
    console.error("ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
    alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
}





function filterMessages() {
  const queryText = document.getElementById("searchInput").value.toLowerCase().trim();
  const selectedPrefix = document.getElementById("prefixFilter")?.value || "";
  const bubbles = document.querySelectorAll(".chat-card");

  // ê²€ìƒ‰ì–´ë¥¼ ê³µë°± ê¸°ì¤€ìœ¼ë¡œ ë¶„ë¦¬
  const searchTokens = queryText.split(/\s+/).filter(Boolean);

  bubbles.forEach(b => {
    const text = b.textContent.toLowerCase();
    const prefixMatch = selectedPrefix === "" || text.includes(selectedPrefix.toLowerCase());

    // ì…ë ¥ëœ ë‹¨ì–´ë“¤ì´ ìˆœì„œëŒ€ë¡œ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    let lastIndex = -1;
    let textMatch = true;
    for (const token of searchTokens) {
      const index = text.indexOf(token, lastIndex + 1);
      if (index === -1) {
        textMatch = false;
        break;
      }
      lastIndex = index;
    }

    b.style.display = (prefixMatch && textMatch) ? "block" : "none";
  });

  const container = document.getElementById("chatBox");
  container.scrollTop = container.scrollHeight;
}






window.addOrUpdateMessage = addOrUpdateMessage;
window.showPasswordPrompt = showPasswordPrompt;
function getKSTDateKey() {
  const now = new Date();
  const kstOffset = 9 * 60 * 60 * 1000; // í•œêµ­ì€ UTC+9
  const kstNow = new Date(now.getTime() + kstOffset);
  return kstNow.toISOString().split('T')[0];
}

window.filterMessages = filterMessages;
window.onload = () => {
  loadMessages();
  countVisitor();
  countTodayUploadRequests();
};





async function countVisitor() {
  const todayKey = getKSTDateKey(); // í•œêµ­ ì‹œê°„ ê¸°ì¤€ ë‚ ì§œ í‚¤
  const visited = localStorage.getItem('visited_' + todayKey);
  if (visited) {
    getVisitorCount(todayKey); // âœ… ë‚ ì§œ ë„˜ê²¨ì¤Œ (í•¨ìˆ˜ë„ ë³€ê²½í–ˆê¸° ë•Œë¬¸)
    return;
  }

  const counterRef = doc(db, "visit_count", todayKey); // âœ… ë‚ ì§œë³„ë¡œ ì €ì¥
  const snap = await getDoc(counterRef);
  if (snap.exists()) {
    const current = snap.data().total || 0;
    await setDoc(counterRef, { total: current + 1 });
    displayVisitorCount(current + 1);
  } else {
    await setDoc(counterRef, { total: 1 });
    displayVisitorCount(1);
  }

  localStorage.setItem('visited_' + todayKey, 'true');
}

async function getVisitorCount(todayKey) {
  const counterRef = doc(db, "visit_count", todayKey); // ë‚ ì§œë³„ ë¬¸ì„œë¡œ ì¡°íšŒ
  const snap = await getDoc(counterRef);
  if (snap.exists()) {
    const current = snap.data().total || 0;
    displayVisitorCount(current);
  } else {
    displayVisitorCount(0); // ì˜¤ëŠ˜ ê¸°ë¡ì´ ì•„ì§ ì—†ì„ ê²½ìš°
  }
}


function displayVisitorCount(count) {
  const visitDiv = document.getElementById("visit-count");
  if (visitDiv) {
    visitDiv.textContent = `ì˜¤ëŠ˜ ë°©ë¬¸ì ìˆ˜: ${count.toLocaleString()}ëª…`;
  }
}countVisitor();
window.submitVisitorMessage = async function() {
  const content = document.getElementById("visitorMessage").value.trim();
  if (!content) return alert("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
  try {
    await addDoc(collection(db, "visitor_requests"), {
      content,
      timestamp: serverTimestamp()
    });
    alert("ì „ì†¡ ì™„ë£Œ. ìˆ˜ë™ ì—…ë°ì´íŠ¸ì´ë‹ˆ ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.");
    document.getElementById("visitorMessage").value = "";
    document.getElementById("visitor-message-box").style.display = "none";
  } catch (e) {
    console.error("ì „ì†¡ ì‹¤íŒ¨", e);
    alert("ì „ì†¡ ì‹¤íŒ¨");
  }
};
document.getElementById("uploadRequestBtn").onclick = () => {
  const box = document.getElementById("visitor-message-box");
  box.style.display = box.style.display === "none" ? "flex" : "none";
};
async function countTodayUploadRequests() {
  const todayKey = getKSTDateKey(); // YYYY-MM-DD
  const start = new Date(`${todayKey}T00:00:00+09:00`);
  const end = new Date(`${todayKey}T23:59:59+09:00`);

  const q = query(collection(db, "visitor_requests"));
  const snapshot = await getDocs(q);

  let count = 0;
  snapshot.forEach(docSnap => {
    const ts = docSnap.data().timestamp?.toDate();
    if (ts && ts >= start && ts <= end) {
      count++;
    }
  });

  const countDiv = document.getElementById("upload-count");
  if (countDiv) {
    countDiv.textContent = `ì˜¤ëŠ˜ ì—…ë¡œë“œ ìš”ì²­: ${count.toLocaleString()}ê±´`;
  }
}

</script>

</body>
</html>